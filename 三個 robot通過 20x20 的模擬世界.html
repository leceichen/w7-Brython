<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>三個 robot 通過 20x20 的模擬世界</title>
<script src="https://cdn.jsdelivr.net/npm/brython@3.10.12/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3.10.12/brython_stdlib.js"></script>
</head>
<body onload="brython()">
<div id="brython_div1"></div>

<script type="text/python">
from browser import document, html, timer

CELL_SIZE = 30
WALL_THICKNESS = 6
IMG_PATH = "https://mde.tw/cp2025/reeborg/src/images/"

# ------------------ 世界 ------------------
class World:
    def __init__(self, width, height):
        self.width = width
        self.height = height
        self.layers = {
            "grid": html.CANVAS(width=self.width*CELL_SIZE, height=self.height*CELL_SIZE),
            "walls": html.CANVAS(width=self.width*CELL_SIZE, height=self.height*CELL_SIZE),
            "objects": html.CANVAS(width=self.width*CELL_SIZE, height=self.height*CELL_SIZE),
            "robots_container": html.DIV()
        }
        self._init_html()
        self._draw_grid()
        self._draw_walls()

    def _init_html(self):
        container = html.DIV(style={
            "position": "relative",
            "width": f"{self.width*CELL_SIZE}px",
            "height": f"{self.height*CELL_SIZE}px"
        })
        for z, key in enumerate(["grid","walls","objects"]):
            canvas = self.layers[key]
            canvas.style = {"position":"absolute","top":"0px","left":"0px","zIndex":str(z)}
            container <= canvas
        # robots container 最上層
        self.layers["robots_container"].style = {
            "position":"absolute","top":"0px","left":"0px",
            "width":f"{self.width*CELL_SIZE}px",
            "height":f"{self.height*CELL_SIZE}px",
            "zIndex":"10"
        }
        container <= self.layers["robots_container"]
        document["brython_div1"].clear()
        document["brython_div1"] <= container

    def _draw_grid(self):
        ctx = self.layers["grid"].getContext("2d")
        ctx.strokeStyle = "#cccccc"
        for i in range(self.width+1):
            ctx.beginPath()
            ctx.moveTo(i*CELL_SIZE,0)
            ctx.lineTo(i*CELL_SIZE,self.height*CELL_SIZE)
            ctx.stroke()
        for j in range(self.height+1):
            ctx.beginPath()
            ctx.moveTo(0,j*CELL_SIZE)
            ctx.lineTo(self.width*CELL_SIZE,j*CELL_SIZE)
            ctx.stroke()

    def _draw_image(self, ctx, src, x, y, w, h, offset_x=0, offset_y=0):
        img = html.IMG()
        img.src = src
        def onload(evt):
            px = x*CELL_SIZE + offset_x
            py = (self.height-1-y)*CELL_SIZE + offset_y
            ctx.drawImage(img, px, py, w, h)
        img.bind("load", onload)

    def _draw_walls(self):
        ctx = self.layers["walls"].getContext("2d")
        for x in range(self.width):
            self._draw_image(ctx, IMG_PATH+"north.png", x, self.height-1, CELL_SIZE, WALL_THICKNESS)
            self._draw_image(ctx, IMG_PATH+"north.png", x, 0, CELL_SIZE, WALL_THICKNESS, offset_y=CELL_SIZE-WALL_THICKNESS)
        for y in range(self.height):
            self._draw_image(ctx, IMG_PATH+"east.png", 0, y, WALL_THICKNESS, CELL_SIZE)
            self._draw_image(ctx, IMG_PATH+"east.png", self.width-1, y, WALL_THICKNESS, CELL_SIZE, offset_x=CELL_SIZE-WALL_THICKNESS)

# ------------------ Robot ------------------
class AnimatedRobot:
    ZINDEX_MAP = {"blue":11, "red":12, "green":13}  # 確保高於 robots_container

    def __init__(self, world, start_pos, color="blue"):
        self.world = world
        self.x, self.y = start_pos
        self.color = color
        self.trace_ctx = world.layers["objects"].getContext("2d")
        self.queue = []
        self.running = False

        # robot canvas 單獨建立
        self.robot_canvas = html.CANVAS(width=self.world.width*CELL_SIZE,
                                        height=self.world.height*CELL_SIZE)
        self.robot_canvas.style = {
            "position":"absolute",
            "top":"0px",
            "left":"0px",
            "zIndex":str(self.ZINDEX_MAP[color])
        }
        self.world.layers["robots_container"] <= self.robot_canvas
        self.robot_ctx = self.robot_canvas.getContext("2d")

        self._draw_robot()

    def _robot_image(self):
        return {"blue":"blue_robot_e.png","red":"red_robot_e.png","green":"green_robot_e.png"}[self.color]

    def _draw_robot(self):
        self.robot_ctx.clearRect(0,0,self.world.width*CELL_SIZE,self.world.height*CELL_SIZE)
        self.world._draw_image(self.robot_ctx, IMG_PATH+self._robot_image(), self.x, self.y, CELL_SIZE, CELL_SIZE)

    def _draw_trace(self, fx, fy, tx, ty):
        ctx = self.trace_ctx
        ctx.strokeStyle = {"blue":"#00f","red":"#f00","green":"#0a0"}[self.color]
        ctx.lineWidth = 2
        ctx.beginPath()
        ctx.moveTo(fx*CELL_SIZE+CELL_SIZE/2,(self.world.height-1-fy)*CELL_SIZE+CELL_SIZE/2)
        ctx.lineTo(tx*CELL_SIZE+CELL_SIZE/2,(self.world.height-1-ty)*CELL_SIZE+CELL_SIZE/2)
        ctx.stroke()

    def follow_path(self, path):
        def action(next_done):
            idx = 0
            def step():
                nonlocal idx
                if idx >= len(path):
                    next_done()
                    return
                fx, fy = self.x, self.y
                self.x, self.y = path[idx]
                self._draw_trace(fx, fy, self.x, self.y)
                self._draw_robot()
                idx += 1
                timer.set_timeout(step,50)
            step()
        self.queue.append(action)
        self._run_queue()

    def _run_queue(self):
        if self.running or not self.queue:
            return
        self.running = True
        action = self.queue.pop(0)
        action(lambda:self._done())

    def _done(self):
        self.running = False
        self._run_queue()

# ------------------ 蛇形路徑 ------------------
def snake_path(x_start, x_end, y_start, y_end):
    path=[]
    for y in range(y_start, y_end+1):
        row=range(x_start,x_end+1)
        if y%2==1:
            row=reversed(row)
        for x in row:
            path.append((x,y))
    return path

# ------------------ 建立世界 & robot ------------------
w = World(20,20)

paths=[
    snake_path(0,19,0,6),   # 藍色
    snake_path(0,19,7,13),  # 紅色
    snake_path(0,19,14,19)  # 綠色
]

robots_instances=[
    AnimatedRobot(w, paths[0][0], "blue"),
    AnimatedRobot(w, paths[1][0], "red"),
    AnimatedRobot(w, paths[2][0], "green")
]

for r,p in zip(robots_instances, paths):
    r.follow_path(p)

</script>
</body>
</html>
